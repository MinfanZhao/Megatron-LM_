# Copyright (c) 2022, NVIDIA CORPORATION.  All rights reserved.

"""Pretrain GPT"""

import torch
from functools import partial
from megatron import get_args
from megatron import print_rank_0
from megatron import get_timers
from megatron import get_tokenizer
from megatron.core import tensor_parallel
from megatron.core.enums import ModelType
from megatron.data.gpt_dataset import build_train_valid_test_datasets
from megatron.model import LLaMAModel
from megatron.training import pretrain
from megatron.utils import get_ltor_masks_and_position_ids, get_ltor_masks_and_position_ids_without_eod
from megatron.utils import average_losses_across_data_parallel_group
torch.set_printoptions(profile='full')
import numpy as np
from megatron.iter_counter import iter_counter
import os
def model_provider(pre_process=True, post_process=True):
    """Build the model."""

    print_rank_0('building LLaMAModel model ...')
    model = LLaMAModel(
        num_tokentypes=0,
        parallel_output=True,
        pre_process=pre_process,
        post_process=post_process
    )
    return model


def get_batch(data_iterator):
    """Generate a batch"""
    args = get_args()
    tokenizer = get_tokenizer()

    # Items and their type.
    keys = ['text']
    datatype = torch.int64

    # Broadcast data.
    if data_iterator is not None:
        data = next(data_iterator)
    else:
        data = None
    data_b = tensor_parallel.broadcast_data(keys, data, datatype)

    # Unpack.
    tokens_ = data_b['text'].long()
    tokens_ = torch.Tensor([[31381, 32014, 35297, 32088, 32019, 33328, 30214, 32454, 34064, 32562,
         30313, 33581, 32587, 30780, 35297, 41909, 30805, 30267,    13, 29992,                                                                                                                                      
         35399, 32930, 32382, 45755, 32322, 31185, 33667, 32213, 33853, 31744,
         30383, 39483, 43946, 32510, 32077, 32231, 30214, 32068, 30287, 31163,
         30287, 36885, 30287, 47799, 31325, 31238, 33068, 30214, 32054, 32502,                                                                                                                                      
         32809, 32036, 30210, 36080, 31267, 42082, 30267, 31238, 40728, 33381,
         39483, 33430, 33446, 30383, 31149, 30287, 30214, 31370, 42877, 35147,      
         30267, 32346, 39483, 40098, 32951, 32586, 36520, 32293, 32157, 31267,
         32855, 33168, 30214, 35147, 33450, 31076, 36093, 39483, 33381, 40762,       
         30214, 32237, 39483, 33812, 31267, 32855, 30214, 35147, 31076, 32098,
         35325, 31584, 32108, 33381, 32453, 30267, 32084, 42877, 35147, 35043,                                                                                                                                      
         30287, 32208, 34820, 33450, 30214, 32244, 32426, 30733, 31074, 30214,
         33050, 32926, 32490, 30214, 33221, 33381, 38879, 30330, 33384, 39207,                                                                                                                                      
         33466, 30267, 31149, 30685, 30214, 31370, 33737, 33835, 30330, 42504,
         32108, 33028, 30214, 35086, 39483, 32855, 33812, 31267, 33168, 30214,                          
         43744, 34960, 32124, 36126, 30330, 32108, 32447, 31184, 33028, 30214,
         38152, 32293, 33507, 30214, 32982, 32288, 39489, 32088, 30214, 32982,                                                                                                                                      
         35663, 33174, 32968, 30503, 36652, 31195, 35103, 30214, 32426, 32001,
         32801, 31267, 34224, 39684, 30210, 32108, 32568, 30267, 32084, 40441,
         35298, 32108, 32447, 30210, 33390, 32568, 30214, 32244, 33221, 32447,
         30210, 31733, 33494, 30214, 41474, 32446, 30267, 31149, 30457, 30214,    
         31370, 38935, 30374, 33381, 33079, 30214, 32346, 33914, 33299, 32442,
         30437, 39483, 32723, 37749, 30330, 37549, 32498, 30503, 39483, 33332,                                                                                                                                      
         32656, 33448, 37749, 31184, 32088, 30214, 30810, 30437, 31931, 32496,
         36093, 30210, 39483, 33390, 32017, 30267,    13, 31238, 34960, 33381,         
         39483, 33430, 33446, 30383, 31149, 30287, 30214, 31370, 33082, 45755,
         32087, 32108, 30214, 40441, 32124, 33028, 30214, 33082, 33381, 35647,                                                                                                                                      
         32092, 35663, 39483, 30267, 31149, 30685, 30214, 31370, 33082, 32893,
         42252, 32854, 32174, 33381, 30214, 33356, 45755, 32893, 32723, 31267,                                                                                                                                      
         33174, 32138, 30267, 30682, 33505, 30210, 33435, 30392, 35231, 32893,                                                                                                                                      
         33042, 30415, 30594, 30354, 30330, 31267, 40823, 31185, 32609, 34665,                                                                                                                                      
         31931, 32138, 33332, 30330, 36274, 33914, 45755, 32893, 31432, 32088,
         31184, 30267, 31149, 30457, 30214, 31370, 40441, 35763, 34224, 33042,         
         33326, 30214, 30505, 35952, 31195, 35103, 30275, 31436, 32311, 33365,
         45755, 31632, 33668, 33242, 30330, 35647, 32185, 33007, 32044, 45755,      
         40976, 31217, 32441, 40359, 45755, 32444, 35192, 30503, 39612, 37399,
         30330, 33584, 36705, 39254, 30330, 35647, 35373, 35673, 31436, 32293,                                                                                                                                      
         32017, 30267, 32084, 31195, 35103, 34224, 30214, 32003, 40665, 33723,
         32905, 39483, 30210, 34733, 30503, 32174, 30267,    13, 29992, 30672,                                                                                                                                      
         34139, 38588, 29899, 33299, 32442, 30383, 33299, 32442, 39483, 30210,
         35347, 30413, 31370, 31557, 31655, 31175, 30909, 33835, 34518, 30214,                                                                                                                                      
         32346, 34015, 44160, 33040, 30267, 31370, 35874, 32457, 32056, 30330,
         32119, 32185, 31184, 32119, 33384, 30214, 32790, 34064, 32124, 32379,                                                                                                                                      
         30651, 39483, 34450, 32725, 33299, 32442, 30437, 39483, 34892, 30267,
            13, 29992, 45662, 30413, 33934, 30383, 32346, 33737, 38040, 35659,                                                                                                                                      
         30214, 34064, 32562, 39483, 30267, 31370, 43649, 35338, 30967, 30330,
         32930, 39791, 34641, 33219, 32725, 30780, 33299, 32442, 39483, 44012,                                                                                                                                      
         30275, 30214, 31666, 38365, 31267, 39483, 35380, 32854, 30214, 32133,
         30214, 30998, 35444, 32338, 39483, 37755, 32017, 35379, 30267,    13,                                                                                                                                      
         29992, 30869, 30670, 31352, 33403, 30745, 30383, 39483, 33909, 30923,
         30330, 32965, 30257, 30214, 35169, 30330, 32124, 30330, 33619, 32100,                                                                                                                                      
         30413, 34214, 30214, 32346, 32237, 39483, 35188, 33881, 37425, 36901,
         30210, 33390, 32290, 30330, 32246, 30214, 32424, 30214, 33135, 41930,
         30607, 33390, 32316, 30214, 32033, 39483, 30923, 32057, 35364, 32127,
         32201, 30267,    13, 37087, 33574, 32149,    13, 33775, 36563, 36442,                                                                                                                                      
         37401, 35546, 32092, 30275, 33406, 30503, 34188,    13, 35546, 32643,                     
         30724, 33998, 32219, 33789, 32087, 30275, 30214, 45993, 35361, 34210,                                                                                                                                      
         30505, 37401, 35546, 32092, 30275, 33406, 30503, 34188, 32277, 30267,      
         33299, 32442, 33567, 32041, 30214, 33072, 30417, 34651, 34579, 30210,                                                                                                                                      
         33041, 30214, 32000, 35546, 32092, 32247, 33249, 30214, 35546, 32643,
         30437, 32217, 35756, 30267, 32532, 32310, 38570, 37401, 32643, 30392,                                                                                                                                      
         30753, 32119, 32692, 32173, 41272, 30267, 34370, 30214, 32228, 35715,
         30743, 31328, 30613, 30856, 30461, 32724, 31023, 32171, 36181, 30864,    
         31731, 31948, 30214, 39526, 35546, 32643, 30210, 35756, 30214, 32008,
         33573, 30743, 31852, 46587, 30319, 30383,    13, 32039, 32284, 39483,
         33390, 30503, 32251, 35546, 32092, 34224, 32088, 30214, 32115, 32703,
         34960, 35529, 31381, 33446, 30214, 39864, 32017, 33174, 30210, 35465,
         30214, 43934, 32666, 34733, 30214, 33481, 38641, 33324, 40960, 30330,
         32703, 45389, 35289, 32857, 32704, 30214, 40066, 32703, 38589, 30330,
         32703, 41061, 30330, 32703, 32174, 32044, 32703, 34702, 35765, 30210,
         32704, 30267,    13, 32122, 30214, 32703, 38589, 32132, 30267, 30505,
         32587, 32562, 39937, 33152, 30214, 32200, 39483, 30437, 31844, 30805,
         31844, 35521, 32116, 34780, 32561, 30214, 32116, 34161, 33090, 37352,
         30214, 32116, 33028, 30503, 31141, 31143, 32561, 30214, 32006, 34161,
         33280, 32504, 33217, 32845, 30940, 30214, 32044, 33389, 39601, 32116,
         36648, 31184, 30267, 30948, 39549, 33390, 30503, 34224, 30275, 30214,
         32014, 32070, 32026, 30769, 36847, 30743, 30214, 31238, 35492, 33059,
      33090, 32116, 32703, 32626, 30503, 32703, 32748, 30214, 38953, 37155,
         32703, 34735, 34237, 30503, 42578, 30267,    13, 32288, 30214, 32703,
         41061, 32132, 30267, 33337, 35647, 39483, 32092, 30783, 32703, 41061,
         35409, 36914, 30267, 30505, 32019, 35546, 32017, 33152, 30214, 45074,
         32728, 37194, 30743, 32175, 39473, 37007, 32017, 41061, 30214, 30847,
         31590, 30594, 35230, 34670, 30330, 30505, 34670, 30594, 41617, 31267,
         32017, 37970, 40762, 30330, 31520, 31594, 35663, 31268, 31361, 30330,
         32182, 31594, 34152, 31184, 30214, 30953, 33801, 30743, 39473, 30313,
         35967, 36307, 34093, 30214, 32188, 30898, 32092, 30214, 35158, 35257,
         30214, 33801, 31267, 32092, 33690, 38584, 35875, 36723, 30267, 32039,
         35546, 32092, 34224, 30214, 30505, 32809, 32978, 30429, 32704, 30743,
         32200, 30210, 33980, 40707, 30330, 33980, 32069, 30330, 33980, 32157,
         30210, 33939, 30214, 30815, 32891, 32338, 33332, 33925, 34323, 30267,
            13, 32631, 30214, 32703, 32174, 32132, 30267, 33299, 32442, 30437,
         30998, 30573, 32200, 39483, 32206, 32001, 33153, 33980, 30330, 33314,
         33980, 30330, 32437, 31266, 33980, 30210, 32371, 30214, 35939, 39560,
         33980, 34796, 30815, 30214, 33241, 30505, 42445, 30275, 32497, 33381,
         32704, 32703, 32174, 30267, 32134, 32893, 30330, 33482, 31184, 36576,
         32174, 30210, 32704, 30267, 32123, 30214, 45074, 30505, 32138, 30275,
         32332, 32119, 34224, 30214, 30505, 34224, 30275, 33291, 33996, 32801,
         32723, 30214, 38828, 32200, 32656, 32174, 30330, 32138, 32174, 30210,
         32704, 33567, 36800, 33229, 32423, 30267, 31412, 32106, 30743, 33975,
         30210, 34224, 35095, 30214, 32104, 32026, 30330, 32267, 32026, 30330,
         41082, 35414, 30953, 42792, 32320, 32704, 30267, 33481, 32038, 30744,
         32019, 30210, 34670, 30658, 32124, 33390, 30214, 32728, 32244, 32507,
         32023, 32138, 30780, 33676, 30374, 32723, 30503, 30374, 33174, 30214,
         30783, 38530, 39971, 32723, 40476, 30330, 32338, 34013, 32092, 34733,
         30953, 42933, 36240, 40676, 33837, 30267,    13, 32039, 36565, 30210,
         35546, 32092, 32784, 32824, 30214, 32200, 32039, 35546, 32092, 30214,
         32728, 32244, 32790, 33581, 33365, 30780, 32119, 34350, 37452, 32482,
         30214, 31267, 32100, 30448, 32100, 31729, 30210, 31594, 31729, 30767,
         32253, 39871, 32019, 32854, 30214, 34015, 32006, 30783, 32119, 30257,
         32291, 30210, 38291, 30214, 32123, 32244, 32472, 32207, 32872, 30330,
         32260, 30330, 35663, 37776, 34912, 30214, 32244, 33801, 33359, 32207,
         32263, 30330, 32511, 30330, 33690, 30330, 38318, 39638, 30847, 31149,
         30748, 37152, 31852, 40253, 30214, 30573, 36771, 34756, 30330, 38162,
         32119, 33746, 33975, 32461, 30267, 32057, 30505, 35546, 32092, 30275,
         33089, 39483, 42716, 30330, 32312, 31143, 30330, 44155, 31184, 36507,
         35529, 30214, 33512, 32789, 32174, 30505, 34796, 31618, 31735, 30705,
         30275, 35289, 32704, 30267,    13, 33121, 30214, 32703, 34702, 32132,
         30267, 34224, 33111, 30214, 35546, 32092, 32088, 30392, 35095, 30503,
         36163, 33172, 30415, 30319, 45259, 30210, 32371, 30214, 32033, 39483,
         30505, 39155, 44212, 33737, 31756, 31143, 31267, 34796, 30815, 30214,
         32244, 32738, 44918, 32023, 30783, 33980, 30210, 32472, 30267, 32105,
         34052, 43112, 39103, 33172, 35188, 30214, 32200, 30505, 32019, 35546,
         32092, 30330, 41021, 38052, 30330, 37026, 32119, 43686, 37256, 30214,
         32244, 33365, 32119, 36812, 30214, 32472, 32119, 32943, 32855, 30267,
         30573, 32119, 31545, 31475, 36302, 34812, 30214, 32200, 30505, 37510,
         30429, 30953, 35289, 32437, 31266, 30214, 32703, 34702, 32387, 36395,
         32338, 30267,    13,   529,   355, 29958,     2, 29871, 37126, 32148,
         31449, 34193, 34370, 30214, 37126, 30461, 34393, 31655, 30330, 37126,
         30461, 32545, 30503, 41224, 31655, 30557, 31798, 38816, 30470, 38188,
         35519, 31122, 42340, 36961, 32446, 30214, 37126, 46326, 31024, 35613,
         34657, 32317, 36961, 32198, 32463, 32446, 30267,    13, 33383, 46326,
         32184, 30210, 35613, 34657, 32317, 30275, 30214, 32248, 32176, 30832,
         32131, 29941, 30502, 30214, 36961, 32446, 34032, 32517, 32317, 31608,
         30753, 40976, 32387, 32704, 32131, 29955, 30502, 30214, 36961, 32446,
         32406, 34521, 32317, 31608, 30888, 35856, 31358, 32550, 32327, 32131,
         29945, 30502, 30214, 36961, 32446, 32029, 35042, 32317, 31608, 45512,
         31893, 30429, 44845, 32131, 29953, 30502, 36961, 32446, 37298, 32317,
         30267, 31389, 36961, 32446, 30998, 36961, 33262, 38188, 34674, 38460,
         34037, 32056, 33326, 32176, 30330, 38188, 34674, 32428, 31947, 34037,
         30330, 32064, 32656, 30330, 32404, 33204, 32176, 30330, 32371, 32176,
         30330, 32348, 38436, 31184, 36961, 36626, 30267,    13, 38188, 35519,
         31122, 32484, 31924, 32974, 36695, 40976, 34157, 35617, 30214, 36240,
         33069, 30429, 34776, 35043, 34153, 32423, 30214, 37126, 46326, 31331,
         30805, 32298, 31751, 42340, 30267, 41447, 30998, 35231, 35648, 33737,
         32447, 33028, 30214, 32338, 38188, 34674, 32447, 30210, 32457, 30267,
            13,   529,   355, 29958,     2, 29871, 33171, 30383,    13,   529,
           355, 29958, 33364, 39049, 31222,    13, 32870, 32036, 30383,    13,
           529,   355, 29958, 41144, 44612, 41813,    13, 40357, 37761, 30383,
            13,   529,   355, 29958, 41009,    13, 33364, 30419, 32848, 30395,
         30409, 39049, 30534, 32088, 33524, 35211, 37711, 32848, 30395, 30467,
         39485, 39049, 31961, 30470, 31266,    13, 32149, 33058, 32599, 32683,
            13, 32036, 30383, 41144, 30470, 29929,    13, 30534, 32114, 30325,
         32215, 37012, 29900, 40724, 37012, 29900,    13, 34751, 30383, 32848,
         30395, 30467, 32128, 34329, 30214, 44874, 30581, 30626, 38927, 30419,
         36819, 34025, 30409,    13,   529,   355, 29958, 37300, 32453, 30383,
         40985, 32848, 30395, 30467, 39367, 33268,    13, 42506, 32453, 30383,
         40985, 34442, 30613, 39049, 32108, 32171,    13, 34986, 32591, 32453,
         30383, 31947, 42696, 32554, 41219, 33608, 29914, 31947, 42696, 32554,
         33608, 29914,    13, 30257, 33666, 30467, 39049, 33608, 29914, 40985,
         39049, 32108, 33326, 40693, 29914, 33364, 32599, 32683, 29914, 40985,
         36389, 31037, 29914, 32848, 30395, 30467, 36153, 38108, 29914, 31266,
         30257, 35253, 29914, 31266, 41825, 31534,    13, 32565, 32298, 30383,
         33364, 31427, 32155, 30330, 33364, 36085, 30330, 33364, 39049, 31222,
         30330, 35649, 32334, 32848, 30395,    13, 32088, 33492, 30383,    13,
           529,   355, 29958, 41144,    13, 30470, 30392, 30866, 33364, 32078,
         31141, 30467, 32599, 37104, 38121, 30843, 32879, 35723, 30214, 42805,
         40985, 39049, 32017, 32459, 32219, 41763, 30705, 36840, 30267,    13,
         30573, 34015, 29871, 33364, 39049, 31109, 29871, 36301, 30214, 43866,
         32599, 32643, 30330, 37104, 32599, 32723, 30214, 40985, 32848, 30395,
         30467, 39367, 33268, 33076, 40985, 34442, 30613, 39049, 32108, 32171,
         32982, 30210, 29871, 32848, 30395, 30467, 39485, 39049, 31961, 30470,
         31266, 30267,    13, 32088, 32316, 30383,    13, 38093, 30631, 32554,
         31599, 31399, 30214, 32031, 29974, 32554, 32372, 46424, 39049, 32599,
         32735, 34494, 30330, 34735, 45000, 32735, 30210, 32599, 34494, 32131,
         31436, 34759, 43857, 32265, 34287, 43510, 30214, 30998, 31999, 30780,
         45725, 30780, 31632, 30210, 33140, 30214, 34237, 36999, 30867, 32897,
         29991,    13,   529,   355, 29958, 32088, 32557, 31611, 33135, 32292,
         30502, 31599, 30956,    13, 33140, 30998, 32587, 31424, 31656, 32048,
         35380, 30214, 31656, 32048, 32302, 31666, 32019, 33402, 32198,    13,
         32088, 32198, 31399, 30383,    13,   529,   355, 29958, 34990, 32268,
            13, 30824, 29911, 41267, 38767, 30419,    13, 32684, 30631,    13,
         30409,    13,   529,   355, 29958, 29906, 30330, 30533, 30462, 39199,
         41844, 40274, 30419, 32004,    13, 31328, 30409,    13,   529,   355,
         29958, 29941, 30330, 32562, 41132, 32198, 31399,    13, 33506, 32290,
         30383, 34132, 31183, 33506,    13, 32379, 32157, 30383, 33619, 43193,
         30214, 31175, 32563, 32708, 30313, 30267,    13, 35126, 30214, 31656,
         34672, 32313, 30313, 32336, 30769, 38299, 42889, 30267,    13,   529,
           355, 29958, 31656, 34672,    13, 34144,    13, 33147, 30780, 30383,
            13,   529,   355, 29958, 32129, 31389, 33335,    13, 38081, 33565,
         30210, 30685, 32432, 31183, 30214, 31656, 34672, 32007,    13, 32007,
         30998, 31479, 32562, 34048, 38490,    13, 33769, 32088,    13, 35297,
         32088, 44118, 30446, 30446, 40512, 30613, 30214, 37691, 33364, 32666,
         32966, 31700, 30214, 33297, 35288, 33180, 32599, 34096, 30015, 31647,
         39664, 30024,    13,   529,   355, 29958, 32031, 32337, 41721, 41248,
         40325, 34911, 29871, 32041,    13, 33364, 32666, 32966, 31700,    13,
         32597, 33167, 32088, 44118, 30990, 32142, 31974, 33167, 30015, 37167,
         31433, 30024, 30214, 37691, 32235, 34066, 38424, 36715,    13, 32031,
         32337, 41721, 34624, 29947, 37591, 29900, 37012, 29900, 29871, 32041,
            13, 30675, 31359, 31047, 32319, 29974, 33364, 33666, 32597, 33167,
         30940,    13, 32995, 32485, 39049, 35569, 32901,   891, 36022, 30446,
         37778, 31911, 30214, 44086, 37902, 34890, 37445, 30505, 35696, 47603,
            13, 32031, 32337, 41721, 43575, 37591, 29900, 37012, 29900, 29871,
         32041,    13, 33976, 37778, 33326,    13, 32173, 32007,    13, 32725,
         33364, 39049, 31829,    13, 32284, 33610, 39049, 32088,    13, 33153,
         39049, 40313,    13, 32081, 32599, 30446, 32228,    13, 33364]]).cuda().long()
    print(tokens_.shape)
    labels = tokens_[:, 1:].contiguous()
    tokens = tokens_[:, :-1].contiguous()
    # Get the masks and postition ids.
    # attention_mask, loss_mask, position_ids = \
    #     get_ltor_masks_and_position_ids_without_eod(tokens, mask_type='megatron')
    attention_mask, loss_mask, position_ids = get_ltor_masks_and_position_ids(
        tokens,
        tokenizer.eod,
        args.reset_position_ids,
        args.reset_attention_mask,
        args.eod_mask_loss)

    return tokens, labels, loss_mask, attention_mask, position_ids

def loss_func(loss_mask, output_tensor):
    losses = output_tensor.float()
    loss_mask = loss_mask.view(-1).float()
    loss = torch.sum(losses.view(-1) * loss_mask) / loss_mask.sum()

    # Reduce loss for logging.
    averaged_loss = average_losses_across_data_parallel_group([loss])
    print("loss function", loss, loss.shape, "avg loss", averaged_loss[0])
    return loss, {'lm loss': averaged_loss[0]}


def forward_step(data_iterator, model):
    """Forward step."""
    iter_num = iter_counter[0]
    print(f"handling iter {iter_num}")
    if not os.path.exists(f"test_data/iter_{iter_num:07d}"):
        os.makedirs(f"test_data/iter_{iter_num:07d}")
    args = get_args()
    timers = get_timers()

    # Get the batch.
    timers('batch-generator', log_level=2).start()
    tokens, labels, loss_mask, attention_mask, position_ids = get_batch(
        data_iterator)
    timers('batch-generator').stop()
    
    output_tensor = model(tokens, position_ids, attention_mask,
                          labels=labels)

    array = output_tensor.detach().cpu().numpy()
    np.savez(f'test_data/iter_{iter_num:07d}/loss.npz', loss=array)

    return output_tensor, partial(loss_func, loss_mask)


def train_valid_test_datasets_provider(train_val_test_num_samples):
    """Build train, valid, and test datasets."""
    args = get_args()

    print_rank_0('> building train, validation, and test datasets '
                 'for LLaMA ...')
    train_ds, valid_ds, test_ds = build_train_valid_test_datasets(
        data_prefix=args.data_path,
        data_impl=args.data_impl,
        splits_string=args.split,
        train_valid_test_num_samples=train_val_test_num_samples,
        seq_length=args.seq_length,
        seed=args.seed,
        skip_warmup=(not args.mmap_warmup),
        train_data_prefix=args.train_data_path,
        valid_data_prefix=args.valid_data_path,
        test_data_prefix=args.test_data_path)
    print_rank_0("> finished creating LLaMA datasets ...")

    return train_ds, valid_ds, test_ds


if __name__ == "__main__":

    pretrain(train_valid_test_datasets_provider, model_provider,
             ModelType.encoder_or_decoder,
             forward_step,
             args_defaults={'tokenizer_type': 'LLaMASentencePieceTokenizer'}
    )
